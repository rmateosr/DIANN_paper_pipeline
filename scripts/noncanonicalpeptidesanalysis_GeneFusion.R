# ABOUTME: Part of the DIA-NN Level 1 pipeline toolchain.
# ABOUTME: Review inputs and paths before running on your environment.
#
# PURPOSE:
#   Downstream analysis of non-canonical peptides arising from gene fusion events.
#   Runs in parallel with noncanonicalpeptidesanalysis_Hotspot.R after the post-
#   processing step. For each fusion-spanning peptide detected by DIA-NN:
#     1. Cross-references detections against the gene fusion peptide library to confirm
#        that detected non-canonical sequences were actually predicted by the library.
#     2. Normalises sample intensities to CPM.
#     3. Produces a PDF plot with one panel per gene fusion.
#
# KEY DISTINCTION FROM HOTSPOT SCRIPT:
#   Hotspot and gene fusion entries share the same input file
#   (non_canonical_sequences_justsequences.txt) but are separated by the ":" character:
#     - Hotspot headers CONTAIN ":" (e.g., Q13485_D537_V:5_SEQUENCE_3)
#     - Gene fusion headers do NOT contain ":" (sequences from fusion library FASTA entries)
#   This script filters for headers WITHOUT ":".
#
# INPUTS:
#   non_canonical_sequences_justsequences.txt — all non-canonical peptide headers
#       (from presentinlibraryparallel_grepjustone.sh).
#   fusionpeptidelistdfunique.tsv             — predicted fusion-spanning peptides
#       generated by Gene_Fusion_Library_Generation.Rscript (pre-pipeline step).
#       Columns: V1=Gene1, V2=Gene2, V3=breakpoint_position, V4=peptide_sequence.
#   Reports/report_peptidoforms.pr_matrix.tsv — DIA-NN quantification matrix.
#
# OUTPUTS (written to Peptidomics_Results/):
#   Peptidomics_results_GeneFusion.tsv              — normalised intensities for detected
#       fusion peptides.
#   gene_fusion_library_presentinanalysis.tsv        — subset of the fusion library that
#       matches detected peptides.
#   Peptidomics_results_canon_and_noncanon_split_bygene_GeneFusion.pdf — one plot per
#       unique fusion pair.

library(stringr)
library(ggplot2)
library(RColorBrewer)
library(reshape2)
library(dplyr)
library(data.table)


# ── 1. Load and filter non-canonical peptide headers ──────────────────────────
# Keep only gene fusion entries — those WITHOUT ":" in the header.
# (Hotspot entries have the format "ProteinID_Ref{pos}_Alt:{count}_Seq_Charge",
#  where ":" appears after the frequency count; fusions lack this pattern.)
noncanonical_peptides = data.frame(fread("non_canonical_sequences_justsequences.txt", header = F, sep = "\t"))
noncanonical_peptides = noncanonical_peptides[grep(":", noncanonical_peptides$V1,invert = TRUE),, drop = FALSE]

# Load the pre-computed gene fusion peptide library (output of Gene_Fusion_Library_Generation.Rscript).
# V4 contains the predicted amino acid sequences of peptides spanning each fusion breakpoint.
gene_fusion_library = data.frame(fread("fusionpeptidelistdfunique.tsv", header = F, sep = "\t"))
genefusion_uniquepeptide = unique(gene_fusion_library$V4)


# ── 2. Extract bare peptide sequences from FASTA headers ──────────────────────
# Same parsing logic as in the Hotspot script: the sequence is the penultimate element
# when the header is split by "_". A loop handles variable-length splits.
noncanonical_peptides_sequence = str_split(noncanonical_peptides$V1, "_")
lengths = unlist(lapply(noncanonical_peptides_sequence, length))
noncanonical_peptides_sequenceonly = c()
for(cont in 1: length(lengths)){
  noncanonical_peptides_sequenceonly= c(noncanonical_peptides_sequenceonly,  noncanonical_peptides_sequence[[cont]][lengths[cont]-1])
}


# ── 3. Intersect detected peptides with the fusion library ────────────────────
# Only retain detected sequences that appear in the fusion library. This filters out
# any non-canonical peptides that were absent from the reference proteome for other
# reasons (e.g., sequencing errors, non-human contaminants) and confirms the detection
# is a bona fide fusion-spanning peptide predicted by the library.
noncanonical_peptides_sequenceonly = noncanonical_peptides_sequenceonly[noncanonical_peptides_sequenceonly %in% genefusion_uniquepeptide ]
gene_fusion_library_presentinanalysis  = gene_fusion_library[gene_fusion_library$V4 %in% noncanonical_peptides_sequenceonly,]


# ── 4. Load DIA-NN quantification matrix and normalise intensities ─────────────
outputDIANN =data.frame(fread("Reports/report_peptidoforms.pr_matrix.tsv"), check.names=FALSE)

# Identify sample intensity columns by the ".raw.dia" file suffix
numericones  =grep("raw.dia", colnames(outputDIANN))
numericoutputDIANN = outputDIANN[,numericones]

# CPM normalisation: divide each sample column by the total detected signal in that
# sample, then scale to 1e6. Corrects for differences in total injected protein amount.
maxnumericoutputDIANN = colSums(numericoutputDIANN,na.rm=T)
normalizednumericoutputDIANN = t(t(numericoutputDIANN)/ maxnumericoutputDIANN)  * 1000000

# Rename sample columns to filename stems (strip path and ".raw.dia" extension)
colnames(normalizednumericoutputDIANN) <- tools::file_path_sans_ext(basename(colnames(outputDIANN)[numericones]))

normalizednumericoutputDIANN = data.frame(normalizednumericoutputDIANN)

# Re-attach metadata columns (all non-intensity columns from the DIA-NN matrix)
metadata = outputDIANN[,grep("raw.dia", colnames(outputDIANN),invert = TRUE)]
normalizednumericoutputDIANN = cbind(normalizednumericoutputDIANN, metadata)


# ── 5. Subset to fusion peptides confirmed in DIA-NN output ───────────────────
normalizednumericoutputDIANN_selection = normalizednumericoutputDIANN[normalizednumericoutputDIANN$Stripped.Sequence%in% noncanonical_peptides_sequenceonly,]

# Save the filtered fusion peptide table and the matched library entries
dir.create("Peptidomics_Results")
write.table(normalizednumericoutputDIANN_selection, "Peptidomics_Results/Peptidomics_results_GeneFusion.tsv", sep = "\t", quote = F, col.names = TRUE, row.names = FALSE )
write.table(gene_fusion_library_presentinanalysis , "Peptidomics_Results/gene_fusion_library_presentinanalysis .tsv", sep = "\t", quote = F, col.names = TRUE, row.names = FALSE )

# Convert numeric-but-metadata columns to character so they are excluded when
# downstream code selects columns by is.numeric(). See Hotspot script for rationale.
normalizednumericoutputDIANN_selection$Proteotypic = as.character(normalizednumericoutputDIANN_selection$Proteotypic)
normalizednumericoutputDIANN_selection$Precursor.Charge = as.character(normalizednumericoutputDIANN_selection$Precursor.Charge)


# ── 6. Build composite Gene_and_mut label ─────────────────────────────────────
# For fusions, "Genes" contains the fusion gene pair (e.g., "GENEA--GENEB") assigned
# by DIA-NN from the fusion FASTA headers. Concatenating with the sequence gives a
# unique key per peptide variant.
normalizednumericoutputDIANN_selection$Gene_and_mut = apply(cbind(normalizednumericoutputDIANN_selection$Genes, normalizednumericoutputDIANN_selection$Stripped.Sequence  ), 1, paste, collapse= "_")

# Select only intensity columns plus the composite key for plotting
numeric_cols <- sapply(normalizednumericoutputDIANN_selection, is.numeric)
selected_normalizednumericoutputDIANN <- normalizednumericoutputDIANN_selection[, c(names(normalizednumericoutputDIANN_selection)[numeric_cols], "Gene_and_mut")]


# ── 7. Colour palette ──────────────────────────────────────────────────────────
myColors <- c(
  "#E41A1C",  # Red
  "#377EB8",  # Blue
  "#4DAF4A",  # Green
  "#984EA3",  # Purple
  "#FF7F00",  # Orange
  "#E5C100",  # Muted Yellow
  "#A65628",  # Brown
  "#F781BF",  # Pink
  "#999999",  # Gray
  "#1B9E77",  # Teal
  "#D95F02",  # Dark Orange
  "#7570B3",  # Deep Blue
  "#66C2A5",  # Soft Cyan
  "#0033A0",  # Intense Blue
  "#F4A6D7",  # Pastel Pink
  "#FC8D62"   # Coral
)


# ── 8. Extract display labels from Gene_and_mut ────────────────────────────────
# Gene_and_mut may contain ";" when DIA-NN assigns the peptide to multiple protein
# groups. For fusions, the last element in the ";" list is typically the most specific
# (fusion-specific) protein group, so we take the last one as the label.
justhefusions = selected_normalizednumericoutputDIANN

labelslist= str_split(justhefusions$Gene_and_mut, ";")
for(nlabel in 1: length(labelslist)){
  labelsthiscase = labelslist[[nlabel]]
  justhefusions$Label[nlabel]  = labelsthiscase[length(labelsthiscase)]
}

# Clean up double underscores that can arise from empty Genes fields
justhefusions$Label = gsub("__", "_", justhefusions$Label)


# ── 9. Deduplicate: keep the row with the highest total intensity per label ────
# Same deduplication logic as in the Hotspot script — retains only the dominant
# charge state per peptide to avoid double-counting in plots.
numeric_cols <- names(justhefusions)[sapply(justhefusions, is.numeric)]
filtered_df <- data.frame(justhefusions %>%
                            rowwise() %>%
                            mutate(Total = sum(c_across(all_of(numeric_cols)), na.rm = TRUE)) %>%
                            group_by(Gene_and_mut,  Label) %>%
                            filter(Total == max(Total, na.rm = TRUE)) %>%
                            ungroup() %>%
                            select(-Total)
)
justhefusions = filtered_df
meltselected_normalizednumericoutputDIANN = reshape2::melt(justhefusions)
# Reverse sample order for consistent top-to-bottom display in coord_flip plots
meltselected_normalizednumericoutputDIANN$variable = factor(meltselected_normalizednumericoutputDIANN$variable , levels = unique(meltselected_normalizednumericoutputDIANN$variable)[length(unique(meltselected_normalizednumericoutputDIANN$variable )):1])


# Remove Proteotypic and Precursor.Charge before plotting (numeric metadata, not intensities)
justhefusions = justhefusions[,!colnames(justhefusions) %in% c("Proteotypic", "Precursor.Charge")]


# ── 10. PDF: One plot per unique fusion pair ───────────────────────────────────
# noncanonLabel contains one entry per unique fusion (de-duplicated by the first gene
# in the pair). For each fusion we gather all peptides related to that event and plot
# their normalised intensities across cell lines.
pdf("Peptidomics_Results/Peptidomics_results_canon_and_noncanon_split_bygene_GeneFusion.pdf", width = 10, height = 15)

noncanonLabel = as.character(unique(justhefusions$Label))
# De-duplicate: keep only the first label per gene pair (first element before "_")
noncanonLabel = noncanonLabel[!duplicated(str_split_fixed(noncanonLabel,"_",2)[,1])]

# Pre-extract sequence and gene name portions of each label for use in the plotting loop.
# Labels can follow two formats depending on whether they contain ":" (older format with
# explicit fusion coordinates) or not (simpler format: GENE1_GENE2_SEQUENCE).
thenoncanonsequences = rep("", length(justhefusions$Label))
thenoncanonnames = rep("", length(justhefusions$Label))

for(n in 1:length(thenoncanonsequences)){
  thislabel = justhefusions$Label[n]
  if(length(grep(":", thislabel))> 0){
    # Older format with coordinate notation: extract 4th "_"-field as sequence
    thenoncanonsequences[n] =  (str_split_fixed(thislabel, "_", 4)[,4])
    thenoncanonnames[n] =  (str_split_fixed(thislabel, "_", 4)[,1])
  } else {
    # Simpler format: last element is sequence, first two elements are gene names
    splitlabel  = unlist(str_split(thislabel, "_"))
    thenoncanonsequences[n] = splitlabel[length(splitlabel)]
    thenoncanonnames[n] =   paste(splitlabel[1:2], collapse = "_")

  }
}


for(cont in 1:length(noncanonLabel)){
  thisselection = justhefusions[grep(noncanonLabel[cont],justhefusions$Label),]
  # Extract the peptide sequence (last "_"-delimited field) and the gene pair (first two fields)
  the_sequence = unlist(str_split(thisselection$Label, "_"))
  the_sequence = the_sequence[length(the_sequence)]
  the_name =paste( unlist(str_split(thisselection$Label, "_"))[1:2], collapse = "_")

  # Gather all rows related to this fusion (no canonical counterpart search for fusions —
  # fusion-spanning peptides are inherently non-canonical and have no reference equivalent)
  thecanon = justhefusions[agrep(the_sequence, justhefusions$Sequence, 1),]
  thenoncanon= justhefusions[agrep(the_sequence, thenoncanonsequences, 1),]
  thisselectionandcanon = unique(rbind(thenoncanon, thecanon))
  thisselectionandcanon$Label = as.character(thisselectionandcanon$Label)
  meltselected_normalizednumericoutputDIANN_thisprot = reshape2::melt(thisselectionandcanon)
  meltselected_normalizednumericoutputDIANN_thisprot$variable = factor(meltselected_normalizednumericoutputDIANN_thisprot$variable , levels = unique(meltselected_normalizednumericoutputDIANN_thisprot$variable)[length(unique(meltselected_normalizednumericoutputDIANN_thisprot$variable )):1])

  # Dummy row to keep shape legend stable (see Hotspot script for explanation)
  dummy_row <- data.frame(
    Gene_and_mut = "",
    Label = meltselected_normalizednumericoutputDIANN_thisprot$Label[1],
    variable = meltselected_normalizednumericoutputDIANN_thisprot$variable[1],
    value = NA
  )
  plot_data <- rbind(meltselected_normalizednumericoutputDIANN_thisprot, dummy_row)
  plot_data$Status = "Mutated"
  plot_data$Status[plot_data$Canon == "TRUE"] = "Not Mutated"
  plot_data$Status = factor(plot_data$Status, levels = c("Not Mutated", "Mutated"))
  plot_data= plot_data[order(plot_data$Status ),]
  plot_data$Label = factor(plot_data$Label, levels = unique(plot_data$Label))
  # circle (16) = canonical; triangle (17) = fusion peptide
  p = ggplot(plot_data, aes(x = variable, y = value , color = Label, shape = Status))   +
    geom_point(size = 3)+ theme_minimal() + coord_flip()  +xlab("Cell Line") + ylab("Normalized Intensity")+
    scale_color_manual(values = myColors) + ggtitle(str_split_fixed(noncanonLabel[cont], "_",2)[1]) +
    scale_shape_manual(values = c("Not Mutated" = 16, "Mutated" = 17), drop = FALSE)

  print(p)

}
dev.off()
